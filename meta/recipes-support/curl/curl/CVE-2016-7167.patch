From 490a7f0ed6203857834f29787483bfcab9fe05a8 Mon Sep 17 00:00:00 2001
From: Daniel Stenberg <daniel@haxx.se>
Date: Tue, 13 Sep 2016 23:00:50 +0200
Subject: [PATCH 02/13] curl_easy_unescape: deny negative string lengths as
 input

Bug: https://curl.haxx.se/docs/adv_20160914.html

CVE-2016-7167
Upstream-Status: Backport
https://github.com/curl/curl/commit/01cf1308ee2e792c77bb1d2c9218c56a30fd40ae

Signed-off-by: Dengke Du <dengke.du@windriver.com>
---
 lib/escape.c | 18 ++++++++++--------
 1 file changed, 10 insertions(+), 8 deletions(-)

diff --git a/lib/escape.c b/lib/escape.c
index 04230b4..4e873d6 100644
--- a/lib/escape.c
+++ b/lib/escape.c
@@ -211,14 +211,16 @@ char *curl_easy_unescape(struct Curl_easy *data, const char *string,
                          int length, int *olen)
 {
   char *str = NULL;
-  size_t inputlen = length;
-  size_t outputlen;
-  CURLcode res = Curl_urldecode(data, string, inputlen, &str, &outputlen,
-                                FALSE);
-  if(res)
-    return NULL;
-  if(olen)
-    *olen = curlx_uztosi(outputlen);
+  if(length >= 0) {
+    size_t inputlen = length;
+    size_t outputlen;
+    CURLcode res = Curl_urldecode(data, string, inputlen, &str, &outputlen,
+                                  FALSE);
+    if(res)
+      return NULL;
+    if(olen)
+      *olen = curlx_uztosi(outputlen);
+  }
   return str;
 }
 
-- 
2.7.4

