qemu: CVE-2016-9915

the patch comes from:
https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2016-9915
http://git.qemu.org/?p=qemu.git;a=commit;h=971f406b77a6eb84e0ad27dcc416b663765aee30

9pfs: add cleanup operation for handle backend driver

In the init operation of handle backend dirver, it allocates a
handle_data struct and opens a mount file. We should free these
resources when the 9pfs device is unrealized. This is what this
patch does.

Signed-off-by: Li Qiang <liq3ea@gmail.com>
Reviewed-by: Greg Kurz <groug@kaod.org>
Signed-off-by: Greg Kurz <groug@kaod.org>

Upstream-Status: Backport

Signed-off-by: Li Wang <li.wang@windriver.com>
---
 hw/9pfs/9p-handle.c |    9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/hw/9pfs/9p-handle.c b/hw/9pfs/9p-handle.c
index 3d77594..0a9c141 100644
--- a/hw/9pfs/9p-handle.c
+++ b/hw/9pfs/9p-handle.c
@@ -649,6 +649,14 @@ out:
     return ret;
 }
 
+static void handle_cleanup(FsContext *ctx)
+{
+    struct handle_data *data = ctx->private;
+
+    close(data->mountfd);
+    g_free(data);
+}
+
 static int handle_parse_opts(QemuOpts *opts, struct FsDriverEntry *fse)
 {
     const char *sec_model = qemu_opt_get(opts, "security_model");
@@ -670,6 +678,7 @@ static int handle_parse_opts(QemuOpts *opts, struct FsDriverEntry *fse)
 
 FileOperations handle_ops = {
     .parse_opts   = handle_parse_opts,
+    .cleanup      = handle_cleanup,
     .init         = handle_init,
     .lstat        = handle_lstat,
     .readlink     = handle_readlink,
-- 
1.7.9.5

