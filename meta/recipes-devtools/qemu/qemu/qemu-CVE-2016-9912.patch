qemu: CVE-2016-9912

the patch comes from:
https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2016-9912
http://www.openwall.com/lists/oss-security/2016/12/08/6

virtio-gpu: call cleanup mapping function in resour

If the guest destroy the resource before detach banking, the 'iov'
and 'addrs' field in resource is not freed thus leading memory
leak issue. This patch avoid this.

Signed-off-by: Li Qiang <address@hidden>

Upstream-Status: Backport

Signed-off-by: Li Wang <li.wang@windriver.com>
---
 hw/display/virtio-gpu.c |    3 +++
 1 file changed, 3 insertions(+)

diff --git a/hw/display/virtio-gpu.c b/hw/display/virtio-gpu.c
index 5b6d17b..84b2c3b 100644
--- a/hw/display/virtio-gpu.c
+++ b/hw/display/virtio-gpu.c
@@ -45,6 +45,8 @@ virtio_gpu_find_resource(VirtIOGPU *g, uint32_t resource_id);
     } while (0)
 #endif
 
+static void virtio_gpu_cleanup_mapping(struct virtio_gpu_simple_resource *res);
+
 static void update_cursor_data_simple(VirtIOGPU *g,
                                       struct virtio_gpu_scanout *s,
                                       uint32_t resource_id)
@@ -358,6 +360,7 @@ static void virtio_gpu_resource_destroy(VirtIOGPU *g,
                                         struct virtio_gpu_simple_resource *res)
 {
     pixman_image_unref(res->image);
+    virtio_gpu_cleanup_mapping(res);
     QTAILQ_REMOVE(&g->reslist, res, next);
     g_free(res);
 }
-- 
1.7.9.5

