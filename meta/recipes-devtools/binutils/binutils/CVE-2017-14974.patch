From e70c19e3a4c26e9c1ebf0c9170d105039b56d7cf Mon Sep 17 00:00:00 2001
From: "H.J. Lu" <hjl.tools@gmail.com>
Date: Fri, 22 Sep 2017 07:25:16 -0700
Subject: [PATCH] x86: Return -1 if bfd_canonicalize_dynamic_reloc returns 0

Stop if bfd_canonicalize_dynamic_reloc returns 0.

	PR binutils/22163
	* elf32-i386.c (elf_i386_get_synthetic_symtab): Also return -1
	if bfd_canonicalize_dynamic_reloc returns 0.
	* elf64-x86-64.c (elf_x86_64_get_synthetic_symtab): Likewise.

(cherry picked from commit b69e9267d15a09ce3f3d4599eae2952dfc6df502)

CVE: CVE-2017-14974
Upstream-Status: Backport(master)

Signed-off-by: Yue Tao <yue.tao@windriver.com>
---
 bfd/ChangeLog      |    7 +++++++
 bfd/elf32-i386.c   |    2 +-
 bfd/elf64-x86-64.c |    2 +-
 3 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/bfd/ChangeLog b/bfd/ChangeLog
index 42d1e51..31e2a7f 100644
--- a/bfd/ChangeLog
+++ b/bfd/ChangeLog
@@ -32,6 +32,13 @@
 	corrupted PLT.
 	* elf64-x86-64.c (elf_x86_64_get_synthetic_symtab): Likewise.
 
+2017-09-22  H.J. Lu  <hongjiu.lu@intel.com>
+
+	PR binutils/22163
+	* elf32-i386.c (elf_i386_get_synthetic_symtab): Also return -1
+	if bfd_canonicalize_dynamic_reloc returns 0.
+	* elf64-x86-64.c (elf_x86_64_get_synthetic_symtab): Likewise.
+
 2017-09-18  H.J. Lu  <hongjiu.lu@intel.com>
 
 	PR ld/22148
diff --git a/bfd/elf32-i386.c b/bfd/elf32-i386.c
index 5c1c3ff..9dc2d25 100644
--- a/bfd/elf32-i386.c
+++ b/bfd/elf32-i386.c
@@ -6342,7 +6342,7 @@ elf_i386_get_synthetic_symtab (bfd *abfd,
 
   dynrelcount = bfd_canonicalize_dynamic_reloc (abfd, dynrelbuf,
 						dynsyms);
-  if (dynrelcount < 0)
+  if (dynrelcount <= 0)
     return -1;
 
   /* Sort the relocs by address.  */
diff --git a/bfd/elf64-x86-64.c b/bfd/elf64-x86-64.c
index 80dd791..558db98 100644
--- a/bfd/elf64-x86-64.c
+++ b/bfd/elf64-x86-64.c
@@ -6717,7 +6717,7 @@ elf_x86_64_get_synthetic_symtab (bfd *abfd,
 
   dynrelcount = bfd_canonicalize_dynamic_reloc (abfd, dynrelbuf,
 						dynsyms);
-  if (dynrelcount < 0)
+  if (dynrelcount <= 0)
     return -1;
 
   /* Sort the relocs by address.  */
-- 
1.7.9.5

