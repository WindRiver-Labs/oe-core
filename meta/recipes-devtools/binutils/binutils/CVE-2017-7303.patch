From a09391eea6398db7090f7dbbac316e3274be2575 Mon Sep 17 00:00:00 2001
From: Nick Clifton <nickc@redhat.com>
Date: Mon, 5 Dec 2016 13:35:50 +0000
Subject: Fix seg-fault attempting to strip a corrupt binary.

	PR binutils/20922
	* elf.c (find_link): Check for null headers before attempting to
	match them.

CVE: CVE-2017-7303
Upstream-Status: Backport[master,a55c9876bb111fd301b4762cf501de0040b8f9db]

Signed-off-by: Yuanjie Huang <yuanjie.huang@windriver.com>
---
 bfd/ChangeLog | 6 ++++++
 bfd/elf.c     | 8 +++++++-
 2 files changed, 13 insertions(+), 1 deletion(-)

diff --git a/bfd/ChangeLog b/bfd/ChangeLog
index 689d7c2b59..2e52bda7bb 100644
--- a/bfd/ChangeLog
+++ b/bfd/ChangeLog
@@ -1,5 +1,11 @@
 2016-12-05  Nick Clifton  <nickc@redhat.com>
 
+	PR binutils/20922
+	* elf.c (find_link): Check for null headers before attempting to
+	match them.
+
+2016-12-05  Nick Clifton  <nickc@redhat.com>
+
 	PR binutils/20921
 	* aoutx.h (squirt_out_relocs): Check for and report any relocs
 	that could not be recognised.
diff --git a/bfd/elf.c b/bfd/elf.c
index cb4de50ac9..4a9643df00 100644
--- a/bfd/elf.c
+++ b/bfd/elf.c
@@ -1249,13 +1249,19 @@ find_link (const bfd * obfd, const Elf_Internal_Shdr * iheader, const unsigned i
   Elf_Internal_Shdr ** oheaders = elf_elfsections (obfd);
   unsigned int i;
 
-  if (section_match (oheaders[hint], iheader))
+  BFD_ASSERT (iheader != NULL);
+
+  /* See PR 20922 for a reproducer of the NULL test.  */
+  if (oheaders[hint] != NULL
+      && section_match (oheaders[hint], iheader))
     return hint;
 
   for (i = 1; i < elf_numsections (obfd); i++)
     {
       Elf_Internal_Shdr * oheader = oheaders[i];
 
+      if (oheader == NULL)
+	continue;
       if (section_match (oheader, iheader))
 	/* FIXME: Do we care if there is a potential for
 	   multiple matches ?  */
-- 
2.11.0

