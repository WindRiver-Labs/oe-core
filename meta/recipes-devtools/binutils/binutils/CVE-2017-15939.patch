From a54018b72d75abf2e74bf36016702da06399c1d9 Mon Sep 17 00:00:00 2001
From: Alan Modra <amodra@gmail.com>
Date: Tue, 26 Sep 2017 09:38:26 +0930
Subject: [PATCH] PR22205, .debug_line file table NULL filename

The PR22200 fuzzer testcase found one way to put NULLs into .debug_line
file tables.  PR22205 finds another.  This patch gives up on trying to
prevent NULL files in the file table and instead just copes with them.
Arguably, this is better than giving up and showing no info from
.debug_line.  I've also fixed a case where the fairly recent DWARF5
support in handling broken DWARG could result in uninitialized memory
reads, and made a small tidy.

	PR 22205
	* dwarf2.c (concat_filename): Return "<unknown>" on NULL filename.
	(read_formatted_entries): Init "fe".
	(decode_line_info <DW_LNE_define_file>): Use line_info_add_file_name.

(cherry picked from commit a54018b72d75abf2e74bf36016702da06399c1d9)

CVE: CVE-2017-15939
Upstream-Status: Backport(master)

binutils 2.27 doesn't support DWARF5, so remove the fix for DWARF5 part.

Signed-off-by: Yue Tao <yue.tao@windriver.com>
---
 bfd/ChangeLog |    7 +++++++
 bfd/dwarf2.c  |   35 +++++++++++++----------------------
 2 files changed, 20 insertions(+), 22 deletions(-)

diff --git a/bfd/ChangeLog b/bfd/ChangeLog
index 5c4cc2b..78f95d1 100644
--- a/bfd/ChangeLog
+++ b/bfd/ChangeLog
@@ -6,6 +6,11 @@
 
 2017-09-26  Alan Modra  <amodra@gmail.com>
 
+	PR 22205
+	* dwarf2.c (concat_filename): Return "<unknown>" on NULL filename.
+
+2017-09-26  Alan Modra  <amodra@gmail.com>
+
 	PR 22209
 	* dwarf2.c (struct comp_unit): Delete sec_info_ptr field.
 	(find_abstract_instance_name): Calculate DW_FORM_ref_addr relative
diff --git a/bfd/dwarf2.c b/bfd/dwarf2.c
index 2c45790..225b4a9 100644
--- a/bfd/dwarf2.c
+++ b/bfd/dwarf2.c
@@ -1471,6 +1471,8 @@ concat_filename (struct line_info_table
     }
 
   filename = table->files[file - 1].name;
+  if (filename == NULL)
+    return strdup ("<unknown>");
 
   if (!IS_ABSOLUTE_PATH (filename))
     {
-- 
1.7.9.5

