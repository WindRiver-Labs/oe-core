From 5b99cf9f559d69f4dc2d9cacb2bb33372bb800ff Mon Sep 17 00:00:00 2001
From: Nick Clifton <nickc@redhat.com>
Date: Thu, 1 Dec 2016 10:49:39 +0000
Subject: Fix a seg-fault disassembling a corrupt binary.

[BZ 20892] -- https://sourceware.org/bugzilla/show_bug.cgi?id=20892

	PR binutils/20892
	* aoutx.h (find_nearest_line): Handle the case where the function
	name is empty.

(cherry picked from commit e82ab856bb4689330c29fb9f1c57a8555b26380e)

Upstream-Status: Backport[master]
CVE: CVE-2017-7224
Signed-off-by: Yuanjie Huang <yuanjie.huang@windriver.com>
---
 bfd/ChangeLog | 4 ++++
 bfd/aoutx.h   | 6 ++++++
 2 files changed, 10 insertions(+)

diff --git a/bfd/ChangeLog b/bfd/ChangeLog
index 15ab5ec660..878f7bdc9b 100644
--- a/bfd/ChangeLog
+++ b/bfd/ChangeLog
@@ -4,6 +4,10 @@
 	* aoutx.h (find_nearest_line): Handle the case where the main file
 	name and the directory name are both empty.
 
+	PR binutils/20892
+	* aoutx.h (find_nearest_line): Handle the case where the function
+	name is empty.
+
 2016-08-02  Nick Clifton  <nickc@redhat.com>
 
 	PR ld/17739
diff --git a/bfd/aoutx.h b/bfd/aoutx.h
index 2715bddec3..1bb205455a 100644
--- a/bfd/aoutx.h
+++ b/bfd/aoutx.h
@@ -2827,6 +2827,12 @@ NAME (aout, find_nearest_line) (bfd *abfd,
       const char *function = func->name;
       char *colon;
 
+      if (buf == NULL)
+	{
+	  /* PR binutils/20892: In a corrupt input file func can be empty.  */
+	  * functionname_ptr = NULL;
+	  return TRUE;
+	}
       /* The caller expects a symbol name.  We actually have a
 	 function name, without the leading underscore.  Put the
 	 underscore back in, so that the caller gets a symbol name.  */
-- 
2.11.0

