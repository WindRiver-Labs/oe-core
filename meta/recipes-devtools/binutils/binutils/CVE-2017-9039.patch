From 271ba01f43c3c5dce12a60021b69ff3a3be8a323 Mon Sep 17 00:00:00 2001
From: Nick Clifton <nickc@redhat.com>
Date: Mon, 3 Apr 2017 12:14:06 +0100
Subject: readelf: Fix overlarge memory allocation when reading a binary with
 an excessive number of program headers.

	PR binutils/21345
	* readelf.c (get_program_headers): Check for there being too many
	program headers before attempting to allocate space for them.

(cherry picked from commit 82156ab704b08b124d319c0decdbd48b3ca2dac5)

CVE: CVE-2017-9039
Upstream-Status: Backport[master]
Signed-off-by: Yuanjie Huang <yuanjie.huang@windriver.com>
---
 binutils/ChangeLog |  6 ++++++
 binutils/readelf.c | 13 ++++++++++++-
 2 files changed, 18 insertions(+), 1 deletion(-)

diff --git a/binutils/ChangeLog b/binutils/ChangeLog
index 959d9ae239..464c40273c 100644
--- a/binutils/ChangeLog
+++ b/binutils/ChangeLog
@@ -1,5 +1,11 @@
 2017-04-03  Nick Clifton  <nickc@redhat.com>
 
+	PR binutils/21345
+	* readelf.c (get_program_headers): Check for there being too many
+	program headers before attempting to allocate space for them.
+
+2017-04-03  Nick Clifton  <nickc@redhat.com>
+
 	PR binutils/21343
 	* readelf.c (get_unwind_section_word): Fix snafu checking for
 	invalid word offsets in ARM unwind information.
diff --git a/binutils/readelf.c b/binutils/readelf.c
index 5ad15764cc..0b0208dec7 100644
--- a/binutils/readelf.c
+++ b/binutils/readelf.c
@@ -4705,8 +4705,19 @@ get_program_headers (FILE * file)
   if (program_headers != NULL)
     return 1;
 
+  /* Be kind to memory checkers by looking for
+     e_phnum values which we know must be invalid.  */
+  if (elf_header.e_phnum
+      * (is_32bit_elf ? sizeof (Elf32_External_Phdr) : sizeof (Elf64_External_Phdr))
+      >= current_file_size)
+    {
+      error (_("Too many program headers - %#x - the file is not that big\n"),
+	     elf_header.e_phnum);
+      return 0;
+    }
+
   phdrs = (Elf_Internal_Phdr *) cmalloc (elf_header.e_phnum,
-                                         sizeof (Elf_Internal_Phdr));
+					 sizeof (Elf_Internal_Phdr));
 
   if (phdrs == NULL)
     {
-- 
2.11.0

