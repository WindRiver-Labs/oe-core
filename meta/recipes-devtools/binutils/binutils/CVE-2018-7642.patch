From 116acb2c268c89c89186673a7c92620d21825b25 Mon Sep 17 00:00:00 2001
From: Alan Modra <amodra@gmail.com>
Date: Wed, 28 Feb 2018 22:09:50 +1030
Subject: [PATCH] PR22887, null pointer dereference in
 aout_32_swap_std_reloc_out

	PR 22887
	* aoutx.h (swap_std_reloc_in): Correct r_index bound check.

(cherry picked from commit 116acb2c268c89c89186673a7c92620d21825b25)

CVE: CVE-2018-7642
Upstream-Status: Backport(master)

Signed-off-by: Yue Tao <yue.tao@windriver.com>
---
 bfd/ChangeLog |    5 +++++
 bfd/aoutx.h   |    6 ++++--
 2 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/bfd/ChangeLog b/bfd/ChangeLog
index 76a6499..42cc700 100644
--- a/bfd/ChangeLog
+++ b/bfd/ChangeLog
@@ -1,3 +1,8 @@
+2018-02-28  Alan Modra  <amodra@gmail.com>
+
+	PR 22887
+	* aoutx.h (swap_std_reloc_in): Correct r_index bound check.
+
 2018-02-28  Nick Clifton  <nickc@redhat.com>
 
 	PR 22894
diff --git a/bfd/aoutx.h b/bfd/aoutx.h
index 4cadbfb..525e560 100644
--- a/bfd/aoutx.h
+++ b/bfd/aoutx.h
@@ -2278,10 +2278,12 @@ NAME (aout, swap_std_reloc_in) (bfd *abf
   if (r_baserel)
     r_extern = 1;
 
-  if (r_extern && r_index > symcount)
+  if (r_extern && r_index >= symcount)
     {
       /* We could arrange to return an error, but it might be useful
-         to see the file even if it is bad.  */
+	 to see the file even if it is bad.  FIXME: Of course this
+	 means that objdump -r *doesn't* see the actual reloc, and
+	 objcopy silently writes a different reloc.  */
       r_extern = 0;
       r_index = N_ABS;
     }
-- 
1.7.9.5

