From 0d76029f92182c3682d8be2c833d45bc9a2068fe Mon Sep 17 00:00:00 2001
From: Alan Modra <amodra@gmail.com>
Date: Sun, 24 Sep 2017 14:35:33 +0930
Subject: [PATCH] PR22167, NULL pointer dereference in scan_unit_for_symbols

	PR 22167
	* dwarf2.c (scan_unit_for_symbols): Check u.blk->data is non-NULL.

(cherry picked from commit 0d76029f92182c3682d8be2c833d45bc9a2068fe)

CVE: CVE-2017-14940
Upstream-Status: Backport(master)

Signed-off-by: Yue Tao <yue.tao@windriver.com>
---
 bfd/ChangeLog |    5 +++++
 bfd/dwarf2.c  |    3 ++-
 2 files changed, 7 insertions(+), 1 deletion(-)

diff --git a/bfd/ChangeLog b/bfd/ChangeLog
index af04da9..57f5ad3 100644
--- a/bfd/ChangeLog
+++ b/bfd/ChangeLog
@@ -11,6 +11,11 @@
 
 2017-09-24  Alan Modra  <amodra@gmail.com>
 
+	PR 22167
+	* dwarf2.c (scan_unit_for_symbols): Check u.blk->data is non-NULL.
+
+2017-09-24  Alan Modra  <amodra@gmail.com>
+
 	PR 22166
 	* elf.c (_bfd_elf_slurp_version_tables): Test sh_info on
 	SHT_GNU_verneed section for sanity.  Don't zalloc memory for
diff --git a/bfd/dwarf2.c b/bfd/dwarf2.c
index 856c963..d1cf1aa 100644
--- a/bfd/dwarf2.c
+++ b/bfd/dwarf2.c
@@ -3210,7 +3210,8 @@ scan_unit_for_symbols (struct comp_unit *unit)
 		    case DW_FORM_block2:
 		    case DW_FORM_block4:
 		    case DW_FORM_exprloc:
-		      if (*attr.u.blk->data == DW_OP_addr)
+		      if (attr.u.blk->data != NULL
+			  && *attr.u.blk->data == DW_OP_addr)
 			{
 			  var->stack = 0;
 
-- 
1.7.9.5

