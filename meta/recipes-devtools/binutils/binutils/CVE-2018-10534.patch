From aa4a8c2a2a67545e90c877162c53cc9de42dc8b4 Mon Sep 17 00:00:00 2001
From: Nick Clifton <nickc@redhat.com>
Date: Tue, 24 Apr 2018 16:31:27 +0100
Subject: [PATCH] Fix an illegal memory access when copying a PE format file
 with corrupt debug information.

	PR 23110
	* peXXigen.c (_bfd_XX_bfd_copy_private_bfd_data_common): Check for
	a negative PE_DEBUG_DATA size before iterating over the debug data.

CVE: CVE-2018-10534
Upstream-Status: Backport[master]
https://sourceware.org/git/gitweb.cgi?p=binutils-gdb.git;h=aa4a8c2a2a67545e90c877162c53cc9de42dc8b4
---
 bfd/ChangeLog  |    6 +
 bfd/peXXigen.c |    9 +
 bfd/po/bfd.pot | 5631 ++++++++++++++++++++++++++------------------------------
 3 files changed, 2662 insertions(+), 2984 deletions(-)

diff --git a/bfd/ChangeLog b/bfd/ChangeLog
index 3c26f8a..32cd893 100644
--- a/bfd/ChangeLog
+++ b/bfd/ChangeLog
@@ -97,6 +97,10 @@
 	* elf.c (ignore_section_sym): Check for the output_section pointer
 	being NULL before dereferencing it.
 
+	PR 23110
+	* peXXigen.c (_bfd_XX_bfd_copy_private_bfd_data_common): Check for
+	a negative PE_DEBUG_DATA size before iterating over the debug data.
+
 2018-04-17  Nick Clifton  <nickc@redhat.com>
 
 	PR 23065
diff --git a/bfd/peXXigen.c b/bfd/peXXigen.c
index bc97984..32ce195 100644
--- a/bfd/peXXigen.c
+++ b/bfd/peXXigen.c
@@ -2993,6 +2993,15 @@ _bfd_XX_bfd_copy_private_bfd_data_common (bfd * ibfd, bfd * obfd)
 		 (uint64_t) (section->size - (addr - section->vma)));
 	      return FALSE;
 	    }
+	  /* PR 23110.  */
+	  else if (ope->pe_opthdr.DataDirectory[PE_DEBUG_DATA].Size < 0)
+	    {
+	      /* xgettext:c-format */
+	      _bfd_error_handler
+		(_("%pB: Data Directory size (%#lx) is negative"),
+		 obfd, ope->pe_opthdr.DataDirectory[PE_DEBUG_DATA].Size);
+	      return FALSE;
+	    }
 
 	  for (i = 0; i < ope->pe_opthdr.DataDirectory[PE_DEBUG_DATA].Size
 		 / sizeof (struct external_IMAGE_DEBUG_DIRECTORY); i++)
-- 
1.7.9.5

