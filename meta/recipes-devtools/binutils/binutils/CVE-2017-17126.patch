From f425ec6600b69e39eb605f3128806ff688137ea8 Mon Sep 17 00:00:00 2001
From: Nick Clifton <nickc@redhat.com>
Date: Thu, 30 Nov 2017 10:25:01 +0000
Subject: [PATCH] Prevent an illegal memory access in readelf when attempting
 to parse a corrupt ELF file.

	PR 22510
	* readelf.c (load_debug_section): Fail if there are no section
	headers available.

(cherry picked from commit f425ec6600b69e39eb605f3128806ff688137ea8)

CVE: CVE-2017-17126
Upstream-Status: Backport(master)

Signed-off-by: Yue Tao <yue.tao@windriver.com>
---
 binutils/ChangeLog |    6 ++++++
 binutils/readelf.c |    4 ++++
 2 files changed, 10 insertions(+)

diff --git a/binutils/ChangeLog b/binutils/ChangeLog
index bacb762..1ea16e4 100644
--- a/binutils/ChangeLog
+++ b/binutils/ChangeLog
@@ -1,3 +1,9 @@
+2017-11-30  Nick Clifton  <nickc@redhat.com>
+
+	PR 22510
+	* readelf.c (load_debug_section): Fail if there are no section
+	headers available.
+
 2017-11-29  Nick Clifton  <nickc@redhat.com>
 
 	PR 22508
diff --git a/binutils/readelf.c b/binutils/readelf.c
index a1f43e6..e0230c7 100644
--- a/binutils/readelf.c
+++ b/binutils/readelf.c
@@ -13264,6 +13264,10 @@ load_debug_section (enum dwarf_section_d
   struct dwarf_section * section = &debug_displays [debug].section;
   Elf_Internal_Shdr * sec;
 
+  /* Without section headers we cannot find any sections.  */
+  if (section_headers == NULL)
+    return FALSE;
+
   /* Locate the debug section.  */
   sec = find_section_in_set (section->uncompressed_name, section_subset);
   if (sec != NULL)
-- 
1.7.9.5

