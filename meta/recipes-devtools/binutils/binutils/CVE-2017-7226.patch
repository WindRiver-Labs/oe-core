From 09b72f3165e727011389092c51131e2dcfcad6c1 Mon Sep 17 00:00:00 2001
From: Nick Clifton <nickc@redhat.com>
Date: Mon, 5 Dec 2016 16:34:45 +0000
Subject: Fix seg-fault in the binutils utilities when reading a corrupt input
 file.

[BZ 20905] -- https://sourceware.org/bugzilla/show_bug.cgi?id=20905

	PR binutils/20905
	* peicode.h (pe_ILF_object_p): Use strnlen to avoid running over
	the end of the string buffer.

(cherry picked from commit fa6631b4eecfcca00c13b9594e6336dffd40982f)

Upstream-Status: Backport[master]
CVE: CVE-2017-7226
Signed-off-by: Yuanjie Huang <yuanjie.huang@windriver.com>
---
 bfd/ChangeLog | 6 ++++++
 bfd/peicode.h | 3 ++-
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/bfd/ChangeLog b/bfd/ChangeLog
index 878f7bdc9b..f03469c95f 100644
--- a/bfd/ChangeLog
+++ b/bfd/ChangeLog
@@ -1,3 +1,9 @@
+2016-12-05  Nick Clifton  <nickc@redhat.com>
+
+	PR binutils/20905
+	* peicode.h (pe_ILF_object_p): Use strnlen to avoid running over
+	the end of the string buffer.
+
 2016-12-01  Nick Clifton  <nickc@redhat.com>
 
 	PR binutils/20891
diff --git a/bfd/peicode.h b/bfd/peicode.h
index a33e71bebe..1dbf3d0840 100644
--- a/bfd/peicode.h
+++ b/bfd/peicode.h
@@ -1264,7 +1264,8 @@ pe_ILF_object_p (bfd * abfd)
     }
 
   symbol_name = (char *) ptr;
-  source_dll  = symbol_name + strlen (symbol_name) + 1;
+  /* See PR 20905 for an example of where the strnlen is necessary.  */
+  source_dll  = symbol_name + strnlen (symbol_name, size - 1) + 1;
 
   /* Verify that the strings are null terminated.  */
   if (ptr[size - 1] != 0
-- 
2.11.0

