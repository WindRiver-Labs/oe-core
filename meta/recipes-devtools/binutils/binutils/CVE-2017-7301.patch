From da3f074e067a506c0b84cee7239d418f1dfb9bd0 Mon Sep 17 00:00:00 2001
From: Nick Clifton <nickc@redhat.com>
Date: Mon, 5 Dec 2016 12:25:34 +0000
Subject: Fix seg-fault in linker parsing a corrupt input file.

	PR ld/20924
	(aout_link_add_symbols): Fix off by one error checking for
	overflow of string offset.

CVE: CVE-2017-7301
Upstream-Status: Backport[master,daae68f4f372e0618d6b9c64ec0f1f74eae6ab3d]

Signed-off-by: Yuanjie Huang <yuanjie.huang@windriver.com>
---
 bfd/ChangeLog | 6 ++++++
 bfd/aoutx.h   | 4 ++--
 2 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/bfd/ChangeLog b/bfd/ChangeLog
index 416eebbb09..f76b0c58be 100644
--- a/bfd/ChangeLog
+++ b/bfd/ChangeLog
@@ -1,3 +1,9 @@
+2016-12-02  Nick Clifton  <nickc@redhat.com>
+
+	PR ld/20924
+	(aout_link_add_symbols): Fix off by one error checking for
+	overflow of string offset.
+
 
 2016-12-02  Nick Clifton  <nickc@redhat.com>
 
diff --git a/bfd/aoutx.h b/bfd/aoutx.h
index e473d9a5fd..193ff06dfe 100644
--- a/bfd/aoutx.h
+++ b/bfd/aoutx.h
@@ -3090,7 +3090,7 @@ aout_link_add_symbols (bfd *abfd, struct bfd_link_info *info)
 	  BFD_ASSERT (p + 1 < pend);
 	  ++p;
 	  /* PR 19629: Corrupt binaries can contain illegal string offsets.  */
-	  if (GET_WORD (abfd, p->e_strx) > obj_aout_external_string_size (abfd))
+	  if (GET_WORD (abfd, p->e_strx) >= obj_aout_external_string_size (abfd))
 	    return FALSE;
 	  string = strings + GET_WORD (abfd, p->e_strx);
 	  section = bfd_ind_section_ptr;
@@ -3126,7 +3126,7 @@ aout_link_add_symbols (bfd *abfd, struct bfd_link_info *info)
 	  ++p;
 	  string = name;
 	  /* PR 19629: Corrupt binaries can contain illegal string offsets.  */
-	  if (GET_WORD (abfd, p->e_strx) > obj_aout_external_string_size (abfd))
+	  if (GET_WORD (abfd, p->e_strx) >= obj_aout_external_string_size (abfd))
 	    return FALSE;
 	  name = strings + GET_WORD (abfd, p->e_strx);
 	  section = bfd_und_section_ptr;
-- 
2.11.0

