From 5e192446314c85f5461e12be98332801780aa528 Mon Sep 17 00:00:00 2001
From: Nick Clifton <nickc@redhat.com>
Date: Fri, 2 Dec 2016 17:46:26 +0000
Subject: Fix seg-fault in linker when passed a corrupt binary input file.

	PR lf/20908
	* elflink.c (bfd_elf_final_link): Check for ELF flavour binaries
	when following indirect links.

CVE: CVE-2017-7299
Upstream-Status: Backport[master,d7f399a8de4c55eb841db6493597a587fac002de]

Signed-off-by: Yuanjie Huang <yuanjie.huang@windriver.com>
---
 bfd/ChangeLog | 6 ++++++
 bfd/elflink.c | 6 ++++++
 2 files changed, 12 insertions(+)

diff --git a/bfd/ChangeLog b/bfd/ChangeLog
index f03469c95f..277be7534b 100644
--- a/bfd/ChangeLog
+++ b/bfd/ChangeLog
@@ -1,3 +1,9 @@
+2016-12-02  Nick Clifton  <nickc@redhat.com>
+
+	PR lf/20908
+	* elflink.c (bfd_elf_final_link): Check for ELF flavour binaries
+	when following indirect links.
+
 2016-12-05  Nick Clifton  <nickc@redhat.com>
 
 	PR binutils/20905
diff --git a/bfd/elflink.c b/bfd/elflink.c
index 3e249400f6..28b25afd09 100644
--- a/bfd/elflink.c
+++ b/bfd/elflink.c
@@ -11198,6 +11198,12 @@ bfd_elf_final_link (bfd *abfd, struct bfd_link_info *info)
 	      asection *sec;
 
 	      sec = p->u.indirect.section;
+	      /* See PR 20908 for a reproducer.  */
+	      if (bfd_get_flavour (sec->owner) != bfd_target_elf_flavour)
+		{
+		  _bfd_error_handler (_("%B: not in ELF format"), sec->owner);
+		  goto error_return;
+		}
 	      esdi = elf_section_data (sec);
 
 	      /* Mark all sections which are to be included in the
-- 
2.11.0

