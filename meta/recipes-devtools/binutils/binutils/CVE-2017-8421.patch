From 712a98d80ef73ddc6081e01c398d4c3d36c0e559 Mon Sep 17 00:00:00 2001
From: Nick Clifton <nickc@redhat.com>
Date: Tue, 2 May 2017 11:54:53 +0100
Subject: Prevent memory exhaustion from a corrupt PE binary with an overlarge
 number of relocs.

	PR 21440
	* objdump.c (dump_relocs_in_section): Check for an excessive
	number of relocs before attempting to dump them.

(cherry picked from commit 39ff1b79f687b65f4144ddb379f22587003443fb)

CVE: CVE-2017-8421
Upstream-Status: Backport[master]
Signed-off-by: Yuanjie Huang <yuanjie.huang@windriver.com>
---
 binutils/ChangeLog | 1 -
 binutils/objdump.c | 8 ++++++++
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/binutils/ChangeLog b/binutils/ChangeLog
index 43265002c0..04c725950a 100644
--- a/binutils/ChangeLog
+++ b/binutils/ChangeLog
@@ -5,7 +5,6 @@
 	string extracted from the section is NUL terminated.
 	(fetch_indirect_string): If the string retrieved from the section
 	is not NUL terminated, return an error message.
-	(fetch_indirect_line_string): Likewise.
 	(fetch_indexed_string): Likewise.
 
 2017-02-14  Nick Clifton  <nickc@redhat.com>
diff --git a/binutils/objdump.c b/binutils/objdump.c
index bf9c5923f1..cbe2e0a621 100644
--- a/binutils/objdump.c
+++ b/binutils/objdump.c
@@ -3238,6 +3238,14 @@ dump_relocs_in_section (bfd *abfd,
       return;
     }
 
+  if ((bfd_get_file_flags (abfd) & (BFD_IN_MEMORY | BFD_LINKER_CREATED)) == 0
+      && relsize > get_file_size (bfd_get_filename (abfd)))
+    {
+      printf (" (too many: 0x%x)\n", section->reloc_count);
+      bfd_set_error (bfd_error_file_truncated);
+      bfd_fatal (bfd_get_filename (abfd));
+    }
+
   relpp = (arelent **) xmalloc (relsize);
   relcount = bfd_canonicalize_reloc (abfd, section, relpp, syms);
 
-- 
2.11.0

