From cb48302df2f29a9954543a33a7ad8566119fa4f3 Mon Sep 17 00:00:00 2001
From: Nick Clifton <nickc@redhat.com>
Date: Fri, 2 Dec 2016 16:41:14 +0000
Subject: Fix seg-fault in the linker when examining a corrupt binary.

	PR ld/20909
	* aoutx.h (aout_link_add_symbols): Fix off-by-one error in check
	for an illegal string offset.

CVE: CVE-2017-7300
Upstream-Status: Backport[master,531336e3a0b79ed60cfc36ad2d6579b6a71175da]

Signed-off-by: Yuanjie Huang <yuanjie.huang@windriver.com>
---
 bfd/ChangeLog | 7 +++++++
 bfd/aoutx.h   | 2 +-
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/bfd/ChangeLog b/bfd/ChangeLog
index 1e1bbac724..416eebbb09 100644
--- a/bfd/ChangeLog
+++ b/bfd/ChangeLog
@@ -1,3 +1,10 @@
+
+2016-12-02  Nick Clifton  <nickc@redhat.com>
+
+	PR ld/20909
+	* aoutx.h (aout_link_add_symbols): Fix off-by-one error in check
+	for an illegal string offset.
+
 2016-12-15  Alan Modra  <amodra@gmail.com>
 
 	PR ld/20968
diff --git a/bfd/aoutx.h b/bfd/aoutx.h
index 1bb205455a..e473d9a5fd 100644
--- a/bfd/aoutx.h
+++ b/bfd/aoutx.h
@@ -3028,7 +3028,7 @@ aout_link_add_symbols (bfd *abfd, struct bfd_link_info *info)
 	continue;
 
       /* PR 19629: Corrupt binaries can contain illegal string offsets.  */
-      if (GET_WORD (abfd, p->e_strx) > obj_aout_external_string_size (abfd))
+      if (GET_WORD (abfd, p->e_strx) >= obj_aout_external_string_size (abfd))
 	return FALSE;
       name = strings + GET_WORD (abfd, p->e_strx);
       
-- 
2.11.0

