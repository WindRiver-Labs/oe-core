From 26c46af87acd16e1de5ca7c1c3a575ece72099c9 Mon Sep 17 00:00:00 2001
From: Nick Clifton <nickc@redhat.com>
Date: Mon, 5 Dec 2016 16:00:43 +0000
Subject: Fix seg-fault in linker when passed a bogus input script.

[BZ 20906] -- https://sourceware.org/bugzilla/show_bug.cgi?id=20906

	PR ld/20906
	* ldlex.l: Check for bogus strings in linker scripts.

(cherry picked from commit 406bd128dba2a59d0736839fc87a59bce319076c)

Upstream-Status: Backport[master]
CVE: CVE-2017-7227
Signed-off-by: Yuanjie Huang <yuanjie.huang@windriver.com>
---
 ld/ChangeLog |  5 +++++
 ld/ldlex.l   | 10 ++++++++--
 2 files changed, 13 insertions(+), 2 deletions(-)

diff --git a/ld/ChangeLog b/ld/ChangeLog
index d95592a525..b98a3a8e9a 100644
--- a/ld/ChangeLog
+++ b/ld/ChangeLog
@@ -1,3 +1,8 @@
+2016-12-05  Nick Clifton  <nickc@redhat.com>
+
+	PR ld/20906
+	* ldlex.l: Check for bogus strings in linker scripts.
+
 2016-08-02  Nick Clifton  <nickc@redhat.com>
 
 	PR ld/17739
diff --git a/ld/ldlex.l b/ld/ldlex.l
index 2eb8fc1020..9130e34971 100644
--- a/ld/ldlex.l
+++ b/ld/ldlex.l
@@ -416,9 +416,15 @@ V_IDENTIFIER [*?.$_a-zA-Z\[\]\-\!\^\\]([*?.$_a-zA-Z0-9\[\]\-\!\^\\]|::)*
 
 <EXPRESSION,BOTH,SCRIPT,VERS_NODE,INPUTLIST>"\""[^\"]*"\"" {
 					/* No matter the state, quotes
-					   give what's inside */
+					   give what's inside.  */
+					bfd_size_type len;
 					yylval.name = xstrdup (yytext + 1);
-					yylval.name[yyleng - 2] = 0;
+					/* PR ld/20906.  A corrupt input file
+					   can contain bogus strings.  */
+					len = strlen (yylval.name);
+					if (len > yyleng - 2)
+					  len = yyleng - 2;
+					yylval.name[len] = 0;
 					return NAME;
 				}
 <BOTH,SCRIPT,EXPRESSION>"\n"		{ lineno++;}
-- 
2.11.0

