From a26a013f22a19e2c16729e64f40ef8a7dfcc086e Mon Sep 17 00:00:00 2001
From: Alan Modra <amodra@gmail.com>
Date: Sun, 24 Sep 2017 17:10:14 +0930
Subject: [PATCH] PR22191, memory leak in dwarf2.c

table->sequences is a linked list before it is replaced by a bfd_alloc
array in sort_line_sequences.

	PR 22191
	* dwarf2.c (decode_line_info): Properly free line sequences on error.

(cherry picked from commit a26a013f22a19e2c16729e64f40ef8a7dfcc086e)

CVE: CVE-2017-14930
Upstream-Status: Backport(master)

Signed-off-by: Yue Tao <yue.tao@windriver.com>
---
 bfd/ChangeLog |    5 +++++
 bfd/dwarf2.c  |    8 ++++++--
 2 files changed, 11 insertions(+), 2 deletions(-)

diff --git a/bfd/ChangeLog b/bfd/ChangeLog
index 450217a..c465462 100644
--- a/bfd/ChangeLog
+++ b/bfd/ChangeLog
@@ -1,3 +1,8 @@
+2017-09-24  Alan Modra  <amodra@gmail.com>
+
+	PR 22191
+	* dwarf2.c (decode_line_info): Properly free line sequences on error.
+
 2017-09-14  Nick Clifton  <nickc@redhat.com>
 
 	PR binutils/22113
diff --git a/bfd/dwarf2.c b/bfd/dwarf2.c
index ec4c311..1566cd8 100644
--- a/bfd/dwarf2.c
+++ b/bfd/dwarf2.c
@@ -2476,8 +2476,12 @@ decode_line_info (struct comp_unit *unit, struct dwarf2_debug *stash)
     return table;
 
  fail:
-  if (table->sequences != NULL)
-    free (table->sequences);
+  while (table->sequences != NULL)
+    {
+      struct line_sequence* seq = table->sequences;
+      table->sequences = table->sequences->prev_sequence;
+      free (seq);
+    }
   if (table->files != NULL)
     free (table->files);
   if (table->dirs != NULL)
-- 
1.7.9.5

