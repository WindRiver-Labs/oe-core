From 2c97d1b001891cc86ed9dcbcc7d3ba83a9620a07 Mon Sep 17 00:00:00 2001
From: Nick Clifton <nickc@redhat.com>
Date: Thu, 1 Dec 2016 15:20:19 +0000
Subject: Fix seg fault attempting to unget an EOF character.

[BZ 20898] -- https://sourceware.org/bugzilla/show_bug.cgi?id=20898

	PR gas/20898
	* app.c (do_scrub_chars): Do not attempt to unget EOF.

(cherry picked from commit 69ace2200106348a1b00d509a6a234337c104c17)

Upstream-Status: Backport [master]
CVE: CVE-2017-7223
Signed-off-by: Yuanjie Huang <yuanjie.huang@windriver.com>
---
 gas/ChangeLog | 5 +++++
 gas/app.c     | 2 +-
 2 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/gas/ChangeLog b/gas/ChangeLog
index fad06dcc81..0ff8d5bf84 100644
--- a/gas/ChangeLog
+++ b/gas/ChangeLog
@@ -1,3 +1,8 @@
+2016-12-01  Nick Clifton  <nickc@redhat.com>
+
+	PR gas/20898
+	* app.c (do_scrub_chars): Do not attempt to unget EOF.
+
 2016-08-05  Nick Clifton  <nickc@redhat.com>
 
 	PR gas/20364
diff --git a/gas/app.c b/gas/app.c
index 38d8e78f21..462a587a04 100644
--- a/gas/app.c
+++ b/gas/app.c
@@ -1187,7 +1187,7 @@ do_scrub_chars (size_t (*get) (char *, size_t), char *tostart, size_t tolen)
 		  state = -2;
 		  break;
 		}
-	      else
+	      else if (ch2 != EOF)
 		{
 		  UNGET (ch2);
 		}
-- 
2.11.0

