From 2c1c4b99a127a0f34e10fe27324d552ccbc54e04 Mon Sep 17 00:00:00 2001
From: Mark Andrews <marka@isc.org>
Date: Thu, 29 Dec 2016 11:07:40 +1100
Subject: [PATCH]     4508.   [security]      Named incorrectly tried to cache
 TKEY records which                             could
 trigger a assertion failure when there was                 
            a class mismatch. (CVE-2016-9131) [RT #43522]

---
 CHANGES            |    4 +-
 lib/dns/resolver.c |   19 +++++++
 4 files changed, 61 insertions(+), 142 deletions(-)

diff --git a/CHANGES b/CHANGES
index 2b3e1ab..92660e3 100644
--- a/CHANGES
+++ b/CHANGES
@@ -1,3 +1,7 @@
+4508.	[security]	Named incorrectly tried to cache TKEY records which
+			could trigger a assertion failure when there was
+			a class mismatch. (CVE-2016-9131) [RT #43522]
+
 4467.   [security]      It was possible to trigger an assertion when
                         rendering a message. (CVE-2016-2776) [RT #43139]
 
diff --git a/lib/dns/resolver.c b/lib/dns/resolver.c
index 161907f..83da471 100644
--- a/lib/dns/resolver.c
+++ b/lib/dns/resolver.c
@@ -6863,6 +6863,19 @@ answer_response(fetchctx_t *fctx) {
 					log_formerr(fctx, "NSEC3 in answer");
 					return (DNS_R_FORMERR);
 				}
+				if (rdataset->type == dns_rdatatype_tkey) {
+					/*
+					 * TKEY is not a valid record in a
+					 * response to any query we can make.
+					 */
+					log_formerr(fctx, "TKEY in answer");
+					return (DNS_R_FORMERR);
+				}
+				if (rdataset->rdclass != fctx->res->rdclass) {
+					log_formerr(fctx, "Mismatched class "
+						    "in answer");
+					return (DNS_R_FORMERR);
+				}
 
 				/*
 				 * Apply filters, if given, on answers to reject
@@ -7049,6 +7062,12 @@ answer_response(fetchctx_t *fctx) {
 			     rdataset != NULL;
 			     rdataset = ISC_LIST_NEXT(rdataset, link))
 			{
+				if (rdataset->rdclass != fctx->res->rdclass) {
+					log_formerr(fctx, "Mismatched class "
+						    "in answer");
+					return (DNS_R_FORMERR);
+				}
+
 				/*
 				 * Only pass DNAME or RRSIG(DNAME).
 				 */
-- 
1.7.9.5

