From 2c1c4b99a127a0f34e10fe27324d552ccbc54e04 Mon Sep 17 00:00:00 2001
From: Mark Andrews <marka@isc.org>
Date: Thu, 29 Dec 2016 11:07:40 +1100
Subject: [PATCH]     4508.   [security]      Named incorrectly tried to cache
 TKEY records which                             could
 trigger a assertion failure when there was                 
            a class mismatch. (CVE-2016-9131) [RT #43522]

---
 CHANGES            |    4 +-
 lib/dns/resolver.c |   19 +++++++
 4 files changed, 61 insertions(+), 142 deletions(-)

diff --git a/CHANGES b/CHANGES
index 97d2e60..b89d82a 100644
--- a/CHANGES
+++ b/CHANGES
@@ -1,3 +1,7 @@
+4508.	[security]	Named incorrectly tried to cache TKEY records which
+			could trigger a assertion failure when there was
+			a class mismatch. (CVE-2016-9131) [RT #43522]
+
 4504.	[security]	Allow the maximum number of records in a zone to
 			be specified.  This provides a control for issues
 			raised in CVE-2016-6170. [RT #42143]
diff --git a/lib/dns/resolver.c b/lib/dns/resolver.c
index 13c8b44..8e560b7 100644
--- a/lib/dns/resolver.c
+++ b/lib/dns/resolver.c
@@ -6787,6 +6787,19 @@ answer_response(fetchctx_t *fctx) {
 					log_formerr(fctx, "NSEC3 in answer");
 					return (DNS_R_FORMERR);
 				}
+				if (rdataset->type == dns_rdatatype_tkey) {
+					/*
+					 * TKEY is not a valid record in a
+					 * response to any query we can make.
+					 */
+					log_formerr(fctx, "TKEY in answer");
+					return (DNS_R_FORMERR);
+				}
+				if (rdataset->rdclass != fctx->res->rdclass) {
+					log_formerr(fctx, "Mismatched class "
+						    "in answer");
+					return (DNS_R_FORMERR);
+				}
 
 				/*
 				 * Apply filters, if given, on answers to reject
@@ -6973,6 +6986,12 @@ answer_response(fetchctx_t *fctx) {
 			     rdataset != NULL;
 			     rdataset = ISC_LIST_NEXT(rdataset, link))
 			{
+				if (rdataset->rdclass != fctx->res->rdclass) {
+					log_formerr(fctx, "Mismatched class "
+						    "in answer");
+					return (DNS_R_FORMERR);
+				}
+
 				/*
 				 * Only pass DNAME or RRSIG(DNAME).
 				 */
