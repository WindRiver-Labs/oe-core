From e86492668e4005eb3b20ba827a7e8474f2888e7e Mon Sep 17 00:00:00 2001
From: Li Zhou <li.zhou@windriver.com>
Date: Wed, 25 Jan 2017 11:01:10 +0800
Subject: [PATCH] openssh: disable Unix-domain socket forwarding when privsep
 is disabled

Upstream-Status: Backport

Signed-off-by: Li Zhou <li.zhou@windriver.com>
---
 serverloop.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/serverloop.c b/serverloop.c
index 3563e5d..233de42 100644
--- a/serverloop.c
+++ b/serverloop.c
@@ -999,7 +999,7 @@ server_request_direct_streamlocal(void)
 
 	/* XXX fine grained permissions */
 	if ((options.allow_streamlocal_forwarding & FORWARD_LOCAL) != 0 &&
-	    !no_port_forwarding_flag) {
+	    !no_port_forwarding_flag && use_privsep) {
 		c = channel_connect_to_path(target,
 		    "direct-streamlocal@openssh.com", "direct-streamlocal");
 	} else {
@@ -1280,7 +1280,7 @@ server_input_global_request(int type, u_int32_t seq, void *ctxt)
 
 		/* check permissions */
 		if ((options.allow_streamlocal_forwarding & FORWARD_REMOTE) == 0
-		    || no_port_forwarding_flag) {
+		    || no_port_forwarding_flag || !use_privsep) {
 			success = 0;
 			packet_send_debug("Server has disabled port forwarding.");
 		} else {
-- 
1.9.1

